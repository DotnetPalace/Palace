@page "/"
@{
	var ghostHostList = runningServiceList.Select(i => i.HostName).Distinct().ToList();
	ghostHostList.RemoveAll(i => hostList.Any(j => j.HostName == i));

	var ghostServiceList = runningServiceList.ToList();
	ghostServiceList.RemoveAll(i => serviceSettingsList.Any(j => j.ServiceName.Equals(i.ServiceName, StringComparison.InvariantCultureIgnoreCase)));
}

<table class="table table-bordered w-100 h-100">
	<thead class="table-light">
		<tr>
			<th colspan="2"></th>
			@if (hostList.Count > 0)
			{
				<th colspan="@hostList.Count">
					Hosts
				</th>
			}
			@if (ghostHostList.Count > 0)
			{
				<th colspan="@ghostHostList.Count">
					Offline Hosts
				</th>
			}
		</tr>
		<tr>
			<th>Group</th>
			<th>Serivce Name</th>
			@foreach (var host in hostList.OrderBy(i => i.HostName))
			{
				var hostStyle = host.HostState == Palace.Shared.HostState.Down ? "table-danger" : "";
				<th class="@hostStyle">
					<RunningHostInfo HostInfo="host"/>
				</th>
			}
			@foreach (var ghostHost in ghostHostList.OrderBy(i => i))
			{
				<th>@ghostHost</th>
			}
		</tr>
	</thead>
	<tbody class="table-group-divider">
		@{
			var oldRowSpan = 0;
		}
		@foreach (var service in serviceSettingsList.OrderBy(i => i.GroupName != null ? i.GroupName : "zzzz").ThenBy(i => i.ServiceName))
		{
			var rowSpan = serviceSettingsList.Count(i => i.GroupName == service.GroupName);
			var packageInfo = packageInfoList.SingleOrDefault(i => i.PackageFileName == service.PackageFileName);
			<tr>
				@if (oldRowSpan != rowSpan)
				{
					oldRowSpan = rowSpan;
					<td rowspan="@rowSpan">
						<span>@service.GroupName</span>
					</td>
				}
				<td>
					<a href="/editservice/@service.ServiceName">@service.ServiceName</a>
					<div>Version Package : <a href="/package/@packageInfo?.PackageFileName">@packageInfo?.CurrentVersion</a></div>
					<div>Date Package : @packageInfo?.LastWriteTime</div>
					@* <ActionButton ButtonType="btn-warning">Recycle all hosts</ActionButton> *@
				</td>
				@foreach (var host in hostList.OrderBy(i => i.HostName))
				{
					var runningService = runningServiceList.SingleOrDefault(i => i.HostName == host.HostName && i.ServiceName == service.ServiceName);
					var serviceStyle = runningService?.ServiceState == ServiceState.Down ? "table-danger" : "";
					<td class="@serviceStyle">
						@if (runningService is not null)
						{
							<table class="table table-borderless table-sm">
								<tbody>
									<tr>
										<td class="w-25">State</td>
										<td class="w-75">
											<b>@runningService.ServiceState</b>
											<small>@runningService.Log</small>
											<span class="text-danger">@runningService.FailReason</span>
										</td>
									</tr>
									<tr>
										<td class="w-25">Version</td>
										<td class="w-75">
											@runningService.Version
										</td>
									</tr>
								</tbody>
							</table>
							@if (runningService.ServiceState == ServiceState.Offline
									|| runningService.ServiceState == ServiceState.Updated)
							{
								<div>
									<ActionButton type="button" ButtonType="btn-primary" @onclick="(() => StartService(host, service))">Start</ActionButton>
									<ActionButton type="button" ButtonType="btn-secondary" @onclick="(() => InstallService(host, service))">ReInstall</ActionButton>
									<ActionButton type="button" ButtonType="btn-danger" @onclick="(() => UnInstallService(host, service))">UnInstall</ActionButton>
								</div>
							}
							else if (runningService.ServiceState == ServiceState.Running)
							{
								<RunningServiceInfo ServiceInfo="runningService"
												OnStopService="(() => StopService(host.HostName, service.ServiceName))"
												OnRecycleService="(() => RecycleService(host.HostName, service))" />
							}
							else if (runningService.ServiceState == ServiceState.Down)
							{
								<ActionButton type="button" ButtonType="btn-danger" @onclick="(() => UnInstallService(host, service))">UnInstall</ActionButton>
							}
						}
						else
						{
							<ActionButton type="button" ButtonType="btn-primary" @onclick="(() => InstallService(host, service))">Install</ActionButton>
						}
					</td>
				}
				@foreach (var ghostHost in ghostHostList.OrderBy(i => i))
				{
					var runningService = runningServiceList.SingleOrDefault(i => i.HostName == ghostHost && i.ServiceName == service.ServiceName);
					<td>
						@if (runningService is not null)
						{
							<RunningServiceInfo ServiceInfo="runningService"
											OnStopService="(() => StopService(ghostHost, service.ServiceName))"
											OnRecycleService="(() => RecycleService(ghostHost, service))" />

						}
					</td>
				}
			</tr>
		}

		@foreach (var ghostService in ghostServiceList.OrderBy(i => i.ServiceName))
		{
			<tr class="table-secondary">
				<td>
				</td>
				<td>
					@ghostService.ServiceName
					<div>Version : @ghostService.Version</div>
					<div>State : @ghostService.ServiceState</div>
				</td>
				@foreach (var host in hostList.OrderBy(i => i.HostName))
				{
					<td>
						@if (ghostService.HostName == host.HostName)
						{
							<div>
								State : @ghostService.ServiceState
								<small>@ghostService.Log</small>
								<span>@ghostService.FailReason</span>
							</div>
							<div>
								Version : @ghostService.Version
							</div>
							<ActionButton type="button" ButtonType="btn-danger" @onclick="(() => StopService(host.HostName, ghostService.ServiceName))">Stop</ActionButton>
						}
					</td>
				}
			</tr>
		}
	</tbody>
</table>


